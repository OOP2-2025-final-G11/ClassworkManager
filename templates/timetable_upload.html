<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>時間割管理アプリ</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='base-style.css') }}"
    />
    <style>
      .container {
        width: 70%;
        margin: 0 auto;
      }

      .upload-box {
        border: 2px dashed #aaa;
        padding: 20px;
        text-align: center;
        margin-top: 20px;
      }

      #loading {
        margin-top: 20px;
        font-weight: bold;
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>時間割管理アプリ</h1>
      <h2>画像アップロードページ</h2>

      <a href="/">← 戻る</a>

      <form id="uploadForm">
        <div class="upload-box" id="dropArea">
           <p>時間割の画像を選択してください（ドラッグ&ドロップ対応）</p>
           <input
           type="file"
           id="imageInput"
           name="image"
           accept="image/*"
           required
           />
         </div>

        <button type="submit">アップロード</button>
      </form>

      <div id="loading">解析中です…</div>
    </div>

    <script>
  const form = document.getElementById("uploadForm");
  const loading = document.getElementById("loading");
  const dropArea = document.getElementById("dropArea");
  const fileInput = document.getElementById("imageInput");
  const fileNameView = document.getElementById("fileName");

  function setFile(file) {
    // file input に反映
    const dt = new DataTransfer();
    dt.items.add(file);
    fileInput.files = dt.files;

    // ファイル名表示
    fileNameView.textContent = `選択中のファイル：${file.name}`;
  }

  // 手動選択時
  fileInput.addEventListener("change", () => {
    if (!fileInput.files.length) return;
    setFile(fileInput.files[0]);
  });

  // submit（ここで初めてアップロード）
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!fileInput.files.length) return;

    loading.style.display = "block";

    const formData = new FormData();
    formData.append("image", fileInput.files[0]);

    try {
      const response = await fetch("/timetable/upload", {
        method: "POST",
        body: formData,
      });

      if (!response.ok) throw new Error();

      window.location.href = "/";
    } catch {
      alert("アップロードに失敗しました");
    } finally {
      loading.style.display = "none";
    }
  });

  // drag over
  ["dragenter", "dragover"].forEach((eventName) => {
    dropArea.addEventListener(eventName, (e) => {
      e.preventDefault();
      dropArea.classList.add("dragover");
    });
  });

  ["dragleave", "drop"].forEach((eventName) => {
    dropArea.addEventListener(eventName, (e) => {
      e.preventDefault();
      dropArea.classList.remove("dragover");
    });
  });

  // drop（★ セットするだけ）
  dropArea.addEventListener("drop", (e) => {
    const files = e.dataTransfer.files;
    if (!files.length) return;
    setFile(files[0]);
  });
</script>


  </body>
</html>
